<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liquid Crystal Phase Analyzer</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    
    <!-- OpenCV.js dengan callback -->
    <script async src="https://docs.opencv.org/4.8.0/opencv.js" 
            onload="console.log('‚úÖ OpenCV.js loaded'); window.opencvLoaded = true;">
    </script>
</head>
<body>
    <!-- ... HTML content sama seperti sebelumnya ... -->

    <!-- Loading Overlay -->
    <div id="opencvLoading" class="loading-overlay">
        <div class="loading-content">
            <i class="fas fa-spinner fa-spin fa-3x"></i>
            <h3>Loading OpenCV Library...</h3>
            <p>This may take a moment (around 10-20MB download)</p>
            <div class="progress">
                <div class="progress-bar"></div>
            </div>
            <p id="opencvProgress">Initializing...</p>
        </div>
    </div>

    <!-- ANALYZER.JS HARUS DILOAD SETELAH SEMUA LIBRARY -->
    <script src="analyzer.js"></script>
    
    <script>
        // Global state
        let analyzerInstance = null;
        let opencvReady = false;
        let domReady = false;
        
        // Fungsi untuk inisialisasi
        function initializeApp() {
            console.log('üöÄ Initializing application...');
            console.log('üì¶ OpenCV ready:', opencvReady);
            console.log('üì¶ DOM ready:', domReady);
            console.log('üì¶ VideoAnalyzer available:', typeof VideoAnalyzer);
            
            if (opencvReady && domReady && typeof VideoAnalyzer !== 'undefined') {
                try {
                    // Hide loading overlay
                    const loadingOverlay = document.getElementById('opencvLoading');
                    if (loadingOverlay) {
                        loadingOverlay.style.display = 'none';
                    }
                    
                    // Create analyzer instance
                    analyzerInstance = new VideoAnalyzer();
                    console.log('‚úÖ VideoAnalyzer instance created:', analyzerInstance);
                    
                    // Initialize
                    if (analyzerInstance && typeof analyzerInstance.init === 'function') {
                        analyzerInstance.init();
                        console.log('üéâ Application initialized successfully!');
                    } else {
                        console.error('‚ùå analyzerInstance.init is not a function');
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error during initialization:', error);
                    alert('Failed to initialize application: ' + error.message);
                }
            } else {
                console.log('‚è≥ Waiting for dependencies...');
            }
        }
        
        // Check if OpenCV is loaded
        function checkOpenCV() {
            if (typeof cv !== 'undefined' && cv.getBuildInformation) {
                console.log('‚úÖ OpenCV detected, version:', cv.getVersionString());
                opencvReady = true;
                document.getElementById('opencvProgress').textContent = 'OpenCV loaded!';
                initializeApp();
            } else {
                // Try again in 500ms
                setTimeout(checkOpenCV, 500);
            }
        }
        
        // Start checking for OpenCV
        setTimeout(checkOpenCV, 1000);
        
        // Wait for DOM to be ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('‚úÖ DOM fully loaded');
            domReady = true;
            initializeApp();
        });
        
        // Fallback timeout
        setTimeout(function() {
            if (!opencvReady) {
                console.warn('‚ö†Ô∏è OpenCV loading timeout');
                document.getElementById('opencvProgress').textContent = 
                    'Taking longer than expected. Please refresh or check connection.';
            }
        }, 30000);
    </script>
</body>
</html>
